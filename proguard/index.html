<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=description content="What ProGuard is all about and how to configure it for Scala on Android"><meta name=keywords content="Scala on Android, Scala, Android, documentation, tutorial, development, ProGuard, MultiDex"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><title>Scala on Android</title><link rel=stylesheet type=text/css media=screen href=/asset/stylesheet/agate.css><link rel=stylesheet type=text/css media=screen href=/asset/stylesheet/main.css><link rel=icon href=/asset/image/favicon.png><link rel=manifest href=/manifest.json><meta property=og:title content="Scala on Android"><meta property=og:description content="What ProGuard is all about and how to configure it for Scala on Android"><meta property=og:type content=website><meta property=og:url content=http://scala-on-android.taig.io/proguard><meta property=og:image content=http://scala-on-android.taig.io/asset/image/scala-android-icon.svg><meta name=twitter:card content=summary><meta name=twitter:title content="Scala on Android"><meta name=twitter:description content="What ProGuard is all about and how to configure it for Scala on Android"><meta name=twitter:image content=http://scala-on-android.taig.io/asset/image/scala-android-icon.svg></head><body><header><div id=title><a href="/"><h1><strong>Scala</strong> on <strong>Android</strong></h1><h2>The comprehensive documentation</h2></a></div><nav><a href="/"><span>Table of contents</span></a><div class=shadow><div class=wrapper><ol><li><a href=/introduction>Introduction</a></li><li><a href=/about>About this documentation</a></li><li><a href=/prerequisites>Prerequisites</a></li><li><a href=/build-tool>Build Tool</a><ol><li><a href=/build-tool/sbt><em>Scala Build Tool (<abbr>sbt</abbr>)</em></a></li></ol></li><li><a href=/project-setup>Project setup</a></li><li><a href=/editor>Editors and <abbr title="Integrated Development Environment">IDE</abbr>s</a><ol><li><a href=/editor/intellij-idea><em>IntelliJ IDEA</em></a></li><li><a href=/editor/android-studio><em>Android Studio</em></a></li></ol></li><li><a href=/command-line>Working with the command line</a></li><li><a href=/dependencies>Dependencies</a></li><li class=active><a href=/proguard><em>ProGuard</em></a><ol><li><a href=/proguard/cache>Cache</a></li></ol></li><li><a href=/typed-resources><em>Typed Resources (<abbr>TR</abbr>)</em></a></li><li><a href=/parcelable><em>Parcelable</em></a></li><li><a href=/testing>Testing</a><ol><li><a href=/testing/robolectric><em>Robolectric</em></a></li></ol></li><li><a href=/library-project>Library projects</a></li><li><a href=/publishing>Publishing</a></li></ol></div></div></nav></header><main id=proguard><section><div class="meta level-2"><button><span>Details</span></button><div class=wrapper><ul><li><span class=label>Information reliability</span> <span class=reliability><strong>Moderate</strong> <em>Might become outdated</em></span></li><li><span class=edit>Last edit</span> <span class=date>Fri Jun 19 22:03:25 2015 +0200</span></li><li><a href=https://github.com/taig/scala-on-android/edit/master/src/main/page/proguard/introduction.html target=_blank>Edit on <em>GitHub</em></a></li></ul></div></div><h2><em>ProGuard</em></h2><blockquote><p>The <em>ProGuard</em> tool shrinks, optimizes, and obfuscates your code by removing unused code and renaming classes, fields, and methods with semantically obscure names. The result is a smaller sized <code class=inline data-language="">.apk</code> file that is more difficult to reverse engineer.</p><footer><a href=http://developer.android.com/tools/help/proguard.html title="ProGuard Android documentation" target=_blank><em>Android</em> developer documentation</a></footer></blockquote><p>In the <em>Java</em> world, <em>ProGuard</em> is an optional step of the build process. With <em>Scala on Android</em> it becomes a necessity. You need <em>ProGuard</em> to remove unused classes and methods. The <em>Android</em> toolchain will fail to compile your app if it contains more than 65.536 methods and fields (the so-called <em>65k limit</em>). This limit is easy to reach when you have the <em>Scala</em> library in your dependencies. Using <em>ProGuard</em> to strip out unused library classes solves this issue. Unfortunately, <em>ProGuard</em> execution is a very time consuming process and its configuration requires a custom syntax.</p></section><section><div class="meta level-2"><button><span>Details</span></button><div class=wrapper><ul><li><span class=label>Information reliability</span> <span class=reliability><strong>Moderate</strong> <em>Might become outdated</em></span></li><li><span class=edit>Last edit</span> <span class=date>Fri Jul 10 19:44:32 2015 +0200</span></li><li><a href=https://github.com/taig/scala-on-android/edit/master/src/main/page/proguard/multidex.html target=_blank>Edit on <em>GitHub</em></a></li></ul></div></div><h3><em>MultiDex</em></h3><p>With <em>Android</em> 5.0 the <em>Android Runtime (<abbr>ART</abbr>)</em> replaced the <em>Dalvik Virtual Machine (<abbr>DVM</abbr>)</em> as the <abbr title="Software Development Kit">SDK</abbr> app execution environment. Already aware of the <em>65k issue</em>, <em>Google</em> equipped <abbr title="Android Runtime">ART</abbr> with a <em>MultiDex</em> mode that allows one app to contain multiple <code class=inline data-language="">.dex</code> files. The <code class=inline data-language="">.dex</code> file is the heart of any <code class=inline data-language="">.apk</code>. Similar to <em>Java</em>'s <code class=inline data-language="">.class</code> file, <code class=inline data-language="">.dex</code> contains the compiled bytecode of your app. But instead of creating one <code class=inline data-language="">.class</code> file for each class (like <em>javac</em> does it), the <code class=inline data-language="">.dex</code> file contains the entire byte code of your app (including dependencies). And this is of course the file in question of the <em>65k limit</em>.</p><p>Now, with <em>Android</em> 5.0 the <em>65k limit</em> still exists, but you may split your bytecode into several <code class=inline data-language="">.dex</code> files which theoretically enables you to ignore the limit and to skip <em>ProGuard</em>. This works also for <em>Android</em> devices with an older version than 5.0, because <em>Google</em> provides a support library for the <em>Dalvik Virtual Machine</em>.</p><p>Since version 1.3.11, the <em>Android SDK Plugin for SBT</em> does also provide <em>MultiDex</em> support and its usage is demonstrated as a <a href=https://github.com/pfn/android-sdk-plugin/tree/master/sbt-test/android-sdk-plugin/hello-multidex title="Android SDK Plugin for SBT sample: MultiDex" target=_blank>sample application</a>. But you are discouraged to use the <em>MultiDex</em> feature to avoid stripping out the <em>Scala</em> overhead because its usage does not come without <a href=https://github.com/pfn/android-sdk-plugin/issues/161 target=_blank>issues</a>. <em>MultiDex</em> is intended for large codebases. You should always make sure to strip out the unused <em>Scala</em> library code. This also has the benefit of keeping your <code class=inline data-language="">.apk</code> as slim as possible.</p></section><section><div class="meta level-2"><button><span>Details</span></button><div class=wrapper><ul><li><span class=label>Information reliability</span> <span class=reliability><strong>Moderate</strong> <em>Might become outdated</em></span></li><li><span class=edit>Last edit</span> <span class=date>Fri Jul 10 19:44:32 2015 +0200</span></li><li><a href=https://github.com/taig/scala-on-android/edit/master/src/main/page/proguard/configuration.html target=_blank>Edit on <em>GitHub</em></a></li></ul></div></div><h3>Configuration</h3><p>By default, the <em>Android SDK Plugin for SBT</em> runs <em>ProGuard</em> with a reasonable <a href=https://github.com/pfn/android-sdk-plugin/blob/master/resources/android-proguard.config title="Android SDK Plugin for SBT ProGuard configuration" target=_blank>default configuration</a> whenever you deploy or package your app. If you need to manually enable or disable it, you can use the <code class="inline highlight">useProguard in <span class=hljs-type>Android</span> := <span class=hljs-literal>true</span></code> <abbr title="Scala Build Tool">sbt</abbr> option. It is automatically enabled when your app contains <em>Scala</em> sources.</p><p>When you pull in external dependencies, <em>ProGuard</em> will likely cause issues, report warnings and abort the build process. This is where you have to step in to add additional configuration rules. When <em>ProGuard</em> raises a warning this usually happens because it detects a reference to a class which does not exist. The <abbr title="Android Software Development Kit">Android SDK</abbr> comes with its own implementation of the <em>Java</em> <abbr title="Application Programming Interface">API</abbr> which misses out on some classes (e.g. the <code class=inline data-language="">java.rmi.*</code> package) so this is not a surprise. A library that supports <em>Android</em> will never call such a missing class when running in this context. It is therefore safe to ignore the warning.</p><p><em>ProGuard</em> may also miss out on classes that are referenced within a library via runtime reflection and remove them too eagerly. If the tool has no chance to detect the usage of a class, it will strip it out and you will encounter <code class=inline data-language="">ClassDefNotFound</code> exceptions at runtime. You then have to manually instruct <em>ProGuard</em> to keep this class.</p><p>Below is a briefly documented sample <em>ProGuard</em> configuration as it may be added to the <abbr title="Scala Build Tool">sbt</abbr> build file.</p><pre class=code><code class=highlight>proguardOptions in <span class=hljs-type>Android</span> ++=
    <span class=hljs-comment>// Don't remove anything from your app's code. This is especially useful during development!</span>
    <span class=hljs-string>"-keep class com.example.** { *; }"</span> ::
    <span class=hljs-comment>// Keep certain library packages</span>
    <span class=hljs-string>"-keep class com.squareup.okhttp.** { *; }"</span> ::
    <span class=hljs-string>"-keep interface com.squareup.okhttp.** { *; }"</span> ::
    <span class=hljs-comment>// Ignore warnings raised from this class</span>
    <span class=hljs-string>"-dontwarn okio.Okio"</span> ::
    <span class=hljs-comment>// Keep all test class</span>
    <span class=hljs-string>"-keep class * extends org.scalatest.FunSuite"</span> ::
    <span class=hljs-comment>// Keep a certain field; being as specific as possible is good practice because it allows</span>
    <span class=hljs-comment>// ProGuard to remove as much unused code as possible which increases your distance to the</span>
    <span class=hljs-comment>// 65K barrier</span>
    <span class=hljs-string>"-keepclassmembernames class com.some.library.Class { int someField; }"</span> ::
    <span class=hljs-comment>// I've read and understood all notes that are issued by this package</span>
    <span class=hljs-string>"-dontnote org.scalatest.**"</span> ::
    <span class=hljs-type>Nil</span></code></pre><p>Make sure to have a look at the <a href=http://proguard.sourceforge.net/manual/usage.html#keepoptions title="Listing and explanation of all available keep options" target=_blank><em>ProGuard</em> keeps options</a> for a comprehensive overview.</p></section><section><div class="meta level-2"><button><span>Details</span></button><div class=wrapper><ul><li><span class=label>Information reliability</span> <span class=reliability><strong>Moderate</strong> <em>Might become outdated</em></span></li><li><span class=edit>Last edit</span> <span class=date>Fri Jul 10 19:44:32 2015 +0200</span></li><li><a href=https://github.com/taig/scala-on-android/edit/master/src/main/page/proguard/example.html target=_blank>Edit on <em>GitHub</em></a></li></ul></div></div><h3>Example</h3><p><a href=https://github.com/square/okio title="GitHub project repository" target=_blank><em>Okio</em></a> is an <abbr title=Input/Output>I/O</abbr> library by <em>square</em> which is also a part of the famous <em>OkHttp</em> library. Depending on <em>Okio</em> causes <em>ProGuard</em> to fail which may look similar to the log output below.</p><pre class=code><code class=highlight>Reading input...
Reading program jar [.../target/android-bin/retrolambda-processed.jar] (filtered)
...
Initializing...
Note: com.fasterxml.jackson.core.type.TypeReference calls 'Class.getGenericSuperclass'
...
<strong>Warning: okio.Okio: can't find referenced class java.nio.file.Files</strong>
...
Note: ...
<strong>Warning: there were 24 unresolved references to classes or interfaces.</strong>
         You may need to add missing library jars or update their versions.
         If your code works fine without the missing classes, you can suppress
         the warnings with '-dontwarn' options.
         (http://proguard.sourceforge.net/manual/troubleshooting.html#unresolvedclass)
<strong>Warning: there were 5 unresolved references to program class members.</strong>
         Your input classes appear to be inconsistent.
         You may need to recompile the code.
         (http://proguard.sourceforge.net/manual/troubleshooting.html#unresolvedprogramclassmember)
[trace] Stack trace suppressed: run last android:proguard for the full output.
[error] (android:proguard) java.io.IOException: Please correct the above warnings first.</code></pre><p><em>ProGuard</em> prevents compilation as long as there are warnings. To solve those you need to stick to the information about the affected classes at the top of the log (e.g. <code class=inline data-language="">Warning: okio.Okio: can't find referenced class java.nio.file.Files</code>). In your <abbr title="Scala Build Tool">sbt</abbr> build configuration, you can now use the <code class="inline highlight">proguardOptions in <span class=hljs-type>Android</span></code> key to add <em>ProGuard</em> rules that instruct it to keep certain packages, classes, fields or methods. This is a trial and error process. To exemplarily solve the <code class=inline data-language="">Okio</code> warning you would first naively try to keep the <code class=inline data-language="">java.nio.file.Files</code> class.</p><pre class=code><code class=highlight>proguardOptions in <span class=hljs-type>Android</span> += <span class=hljs-string>"-keep class java.nio.file.Files { *; }"</span></code></pre><p>This is usually the first attempt to tackle <em>ProGuard</em> warnings that occur after adding a new dependency. In most cases this is also a sufficient solution. Not in this one, though. <em>Okio</em> is a <em>Java</em> <abbr title=Input/Output>I/O</abbr> library that also works with <em>Android</em>. The affected class <code class=inline data-language="">java.nio.file.Files</code> is part of the <em>Java</em> <abbr title="Software Development Kit">SDK</abbr>, but does not exist on <em>Android</em>. Forcing <em>ProGuard</em> to keep the class is therefore not a valid solution because the class does not exist in the first place. Instead we have to rely on <em>Okio</em> to know how to properly handle the <em>Android</em> environment and instead instruct <em>ProGuard</em> to ignore the issue.</p><pre class=code><code class=highlight>proguardOptions in <span class=hljs-type>Android</span> += <span class=hljs-string>"-dontwarn okio.Okio"</span></code></pre><p>Suppressing warnings is a dangerous undertaking because it may cause runtime errors if your app (or some underlying library) tries to call a class that does not exist. It also hides all further issues related to the <code class=inline data-language="">okio.Okio</code> class. Only use it as a last resort to handle <em>ProGuard</em> warnings.</p><aside class="alert warning"><p>This example should make it obvious that configuring <em>ProGuard</em> is not a trivial task. You are forced to learn and understand its options. Getting it right is time consuming because every change forces you to rerun the costly <em>ProGuard</em> process. Furthermore, solving problems does usually force you to drill down on implementation details of foreign code.</p></aside></section><section data-src=sources.js data-level=0><h3>Further reading</h3><ul class=further-reading><li><a href="http://proguard.sourceforge.net/" target=_blank><em>ProGuard</em></a><p>Official project page</p></li><li><a href=http://developer.android.com/tools/help/proguard.html target=_blank><em>ProGuard</em> <em>Android</em> documentation</a><p><em>Android</em> developer documentation about <em>ProGuard</em></p></li><li><a href=http://proguard.sourceforge.net/manual/usage.html#keepoptions target=_blank><em>ProGuard</em> keeps options</a><p>Listing and explanation of all available keep options</p></li><li><a href=https://developer.android.com/tools/building/multidex.html target=_blank><em>Android</em> documentation: <em>MultiDex</em></a><p>Official documentation</p></li><li><a href=https://github.com/pfn/android-sdk-plugin/tree/master/sbt-test/android-sdk-plugin/hello-multidex target=_blank><em>Android SDK Plugin for SBT</em> sample: <em>MultiDex</em></a><p><em>GitHub</em> repository</p></li></ul></section><section><h3>Comments</h3><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname="scala-on-android",disqus_identifier="proguard",disqus_title="Scala on Android";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></section></main><footer><div class=story><div class=back><a href=/dependencies>Dependencies</a></div><div class=continue><a href=/proguard/cache>Cache</a></div></div><div class=fixtures><div class=left><ul><li><a href="https://github.com/taig/scala-on-android/" title="Scala on Android" target=_blank>Fork me on <em>GitHub</em></a></li><li><a href=/help>Getting help</a></li></ul></div><div class=center><img src=/asset/image/scala-android-logo.svg alt="Scala on Android logo"> <span class=version>Version 1.0.6</span></div><div class=right><ul><li><a href=/sources>Sources</a></li><li><a href=/software>Software</a></li><li><a href=/abbreviations>Abbreviations</a></li></ul></div></div></footer><script data-main=/asset/javascript/main src=/asset/javascript/require-2.1.17.min.js></script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-64109905-1","auto"),ga("send","pageview");</script><script type=application/ld+json>{
	"@context" : "http://schema.org",
	"@type" : "WebSite",
	"name" : "Scala on Android",
	"url" : "http://scala-on-android.taig.io/"
}</script><script type=application/ld+json>{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement":
	[
		
		{
			"@type": "ListItem",
			"position": 1,
			"item":
			{
				"@id": "/proguard",
				"name": "ProGuard"
			}
		}
		
	]
}</script></body></html>